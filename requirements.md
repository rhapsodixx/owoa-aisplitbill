# AI Split Bill - Product Requirements

## üìå Product Overview

**Product Name:** AI Split Bill
**Platform:** Mobile-first Web App
**Primary User Goal:**
Allow users to upload a receipt, describe how food/drinks were consumed, and receive an accurate, fair split of the total bill using AI.

---

## üìÑ Page Structure (STRICT)

The application has **ONLY TWO (2) PAGES**:

### **Page 1: Bill Input Page**

This page collects all user inputs required for AI processing.

#### Required Inputs

1.  **Receipt Image Upload**

    - **Type:** File upload
    - **Mandatory:** YES
    - **Accepted formats:** JPG, PNG, WEBP
    - **Purpose:** Source of all item prices, taxes, service fees, and totals
    - **Storage:** Image MUST be uploaded to Supabase Object Storage (see [Receipt Image Storage](#receipt-image-storage))

2.  **Number of People**

    - **Type:** Number input
    - **Mandatory:** YES
    - **Validation rules:**
      - Must be an integer
      - Must be greater than 0
      - Cannot be empty

3.  **Extra Instructions**
    - **Type:** Multiline text input
    - **Mandatory:** NO
    - **Purpose:** Provide additional context to the AI for accurate splitting
    - **Examples:**
      - "Person A ate noodles and tea"
      - "Person B ate fried rice only"
      - "Person C shared dessert with Person A"
      - "One person ate multiple dishes and drinks"

#### Page 1 Behavior

- User **cannot proceed** unless:
  - Receipt image is uploaded
  - Number of people is valid
- On submit, all inputs are sent to the AI processing layer
- Receipt image is uploaded to Supabase Object Storage before or alongside AI processing

### **Page 2: Split Bill Result Page**

This page displays the structured output generated by the AI.

**URL Pattern:** `/result/{uuid}`

- Each result is accessible via a unique, cryptographically random UUID v4
- The page is publicly accessible without authentication
- Direct URL access does NOT count as an additional page

#### Output Requirements

The AI must return data that can be rendered into:

- A **clear per-person breakdown**
- Each person must have:
  - List of food items
  - List of drink items
  - Subtotal before additional fees
  - Allocated tax amount
  - Allocated service fee
  - Final total payable

#### Calculation Rules (MANDATORY)

- All taxes, service fees, and additional charges:
  - MUST be included in the final calculation
  - MUST be distributed **proportionally**, based on the value of food/drinks consumed by each person
- No rounding assumptions unless explicitly stated by the AI
- Final totals must be clearly shown per person

#### Presentation Requirements

- Output must be:
  - Human-readable
  - Structured
  - Visually scannable
- Example sections:
  - Person 1 Summary
  - Person 2 Summary
  - Grand Total (reference)

#### Share Functionality

- A **Share button** MUST be displayed on the result page
- Behavior:
  - Copies the full UUID-based result URL to clipboard
  - Uses shadcn `Button` component
  - Shows feedback using shadcn `Toast` component
- Constraints:
  - No social SDKs
  - No third-party share libraries

#### Receipt Image Display

- The original receipt image MUST be displayed at the bottom of the result page
- Display requirements:
  - Wrapped inside a shadcn `Card` component
  - Clearly labeled (e.g., "Original Receipt")
  - Read-only (no editing or replacement)
  - Uses shadcn-friendly layout components (e.g., `AspectRatio`, `ScrollArea`)

---

## üóÑÔ∏è Data Persistence & Storage

### Supabase Database

All AI-generated split bill results MUST be persisted in Supabase.

#### Storage Timing

- Results are stored **immediately after successful AI processing**
- Writes occur **server-side only**

#### Result Record Schema

| Field              | Type      | Description                              |
| ------------------ | --------- | ---------------------------------------- |
| `id`               | UUID (PK) | Cryptographically random UUID v4         |
| `result_data`      | JSON      | Structured split bill result             |
| `currency`         | TEXT      | Currency code (e.g., "IDR", "USD")       |
| `person_breakdown` | JSON      | Per-person allocation details            |
| `fees_taxes`       | JSON      | Allocated fees and taxes breakdown       |
| `receipt_image_url`| TEXT      | Public or signed URL to the receipt      |
| `created_at`       | TIMESTAMP | Timestamp of record creation             |
| `ai_model_used`    | TEXT      | Identifier of the AI model used          |

#### UUID Rules (NON-NEGOTIABLE)

- UUIDs MUST:
  - Be cryptographically random (UUID v4)
  - Be non-guessable
  - Be generated server-side
- UUIDs MUST NOT:
  - Be sequential
  - Be derived from timestamps
  - Be hashed from internal IDs
  - Encode user or bill metadata

### Receipt Image Storage

- Receipt images MUST be uploaded to **Supabase Object Storage**
- Upload timing: Before or alongside AI processing
- Storage rules:
  - Images are **immutable** after upload (no modification or replacement)
  - Image URL is public-read or signed-read (implementation choice)
  - The stored image URL MUST be saved with the result record

---

## üîê Security & Access Control

### Public Result Access

- Result pages are:
  - Publicly accessible via UUID
  - Read-only (no modifications allowed)
  - Non-enumerable (no listing or pagination)
- No authentication required to view results

### Server-Side Security

- Supabase service keys MUST remain server-side only
- No sensitive or personal data is exposed on public result pages
- Results CANNOT be deleted or updated via public access
- Receipt images cannot be modified or replaced after upload

---

## üé® UI & Design System (NON-NEGOTIABLE)

### Component Rules

ALL UI components MUST:
- Use **shadcn components only**
- Follow shadcn composition and variant patterns

### Allowed

- shadcn components (Button, Card, Input, Toast, Alert, AspectRatio, ScrollArea, etc.)
- Tailwind utility classes for spacing/layout

### Forbidden

- Custom UI components (components not from shadcn)
- Inline styles
- Third-party UI libraries

---

## ü§ñ AI & LLM Configuration

### AI Responsibilities

The AI is responsible for:

- Reading and interpreting receipt image contents
- Extracting item names, prices, taxes, and fees
- Mapping items to individuals based on extra instructions
- Calculating fair cost distribution
- Producing structured, explainable output

### LLM Provider

- **API Gateway:** OpenRouter API

### Models

- **Default Model:** `openai/gpt-4o-mini`
- **Fallback Model:** `google/gemini-2.0-flash-001`

### Configuration Rules

- LLM model selection MUST be configurable via environment variables
- No model identifiers may be hardcoded

---

## üß† Prompting & Safety Rules

- AI prompts must:
  - Include receipt OCR data
  - Include number of people
  - Include user extra instructions verbatim
- Input must be sanitized to reduce prompt injection risk
- AI output must be deterministic and structured

---


---

## ‚öôÔ∏è Environment Variables & Configuration

### Critical Configuration Rules

- **Source of Truth:** `.env.example` is the comprehensive reference for all required variables.
- **Production Safety:** `.env` files MUST NEVER be committed to version control.
- **Runtime Injection:** Variables are injected at runtime in the deployment environment (Render).

### Required `.env` Variables

```env
# Runtime Implementation
NODE_ENV=development
PORT=3000

# AI Provider Configuration (OpenRouter)
OPENROUTER_API_KEY=
OPENROUTER_MODEL_DEFAULT=openai/gpt-4o-mini
OPENROUTER_MODEL_FALLBACK=google/gemini-2.0-flash-001

# Supabase Configuration
# Note: Service Role Key is strictly SERVER-SIDE only.
SUPABASE_URL=
SUPABASE_ANON_KEY=
SUPABASE_SERVICE_ROLE_KEY=
```


---

## üéØ Non-Goals (Explicitly Out of Scope)

- User authentication
- User accounts
- History of past bills
- Payments or payment integrations
- More than 2 pages
- Manual editing of extracted receipt items
- Dashboards or admin panels
- Pagination or result listing
- Social sharing SDKs
