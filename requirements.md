# AI Split Bill - Product Requirements

## üìå Product Overview

**Product Name:** AI Split Bill
**Platform:** Mobile-first Web App
**Primary User Goal:**
Allow users to upload a receipt, describe how food/drinks were consumed, and receive an accurate, fair split of the total bill using AI.

---

## üìÑ Page Structure (STRICT)

The application has **ONLY TWO (2) PUBLIC PAGES** and **ONE (1) PROTECTED ADMIN AREA**:

### **Page 1: Bill Input Page**

This page collects all user inputs required for AI processing.

#### Required Inputs

1.  **Receipt Image Upload**

    - **Type:** File upload
    - **Mandatory:** YES
    - **Accepted formats:** JPG, PNG, WEBP
    - **Purpose:** Source of all item prices, taxes, service fees, and totals
    - **Storage:** Image MUST be uploaded to Supabase Object Storage (see [Receipt Image Storage](#receipt-image-storage))

2.  **Number of People**

    - **Type:** Number input
    - **Mandatory:** YES
    - **Validation rules:**
      - Must be an integer
      - Must be greater than 0
      - Cannot be empty

3.  **Extra Instructions**
    - **Type:** Multiline text input
    - **Mandatory:** NO
    - **Purpose:** Provide additional context to the AI for accurate splitting
    - **Examples:**
      - "Person A ate noodles and tea"
      - "Person B ate fried rice only"
      - "Person C shared dessert with Person A"
      - "One person ate multiple dishes and drinks"

4.  **Result Visibility Selector**
    - **Type:** Selector (Select or RadioGroup)
    - **Mandatory:** YES
    - **Default Value:** Public
    - **Options:**
      - Public
      - Private
    - **Behavior:**
      - **Public:** Passcode field is HIDDEN
      - **Private:** Passcode field is SHOWN and REQUIRED
    - **UI Requirements:** Must use shadcn `Select` or `RadioGroup` component

5.  **Passcode Field (Conditional)**
    - **Type:** Text Input (or Password Input)
    - **Mandatory:** YES (only if Visibility is Private)
    - **Visibility:** Hidden if Visibility is Public
    - **Validation Rules:**
      - Max length: 8 characters
      - Must be non-empty (if Private)
      - Trim whitespace
    - **UI Requirements:**
      - Use shadcn `Input` component
      - Display errors via shadcn `FormMessage`
      - Helper text: "Up to 8 characters" via shadcn `FormDescription`

6.  **Payment Instruction (Optional)**
    - **Type:** Multiline text input
    - **Mandatory:** NO
    - **Purpose:** Let the creator specify how others should pay (bank/e-wallet/etc.)
    - **Examples:**
      - "Payment to BCA bank account 861209892"
      - "Pay to OVO +6285725706128"
    - **Validation Rules:**
      - Max length: 300 characters
      - Trim leading/trailing whitespace
      - Allow numbers and symbols as typed (do not restrict formatting)
    - **UI Requirements (STRICT shadcn):**
      - Use shadcn `Textarea` component
      - Use shadcn `FormDescription` to explain: "Optional ‚Äî shown on the result page if filled"
      - Use shadcn `FormMessage` for validation errors (if any, e.g., exceeding max length)

#### Page 1 Behavior

- User **cannot proceed** unless:
  - Receipt image is uploaded
  - Number of people is valid
- On submit, all inputs (including visibility, passcode if private, and payment instruction if provided) are sent to the AI processing layer
- Receipt image is uploaded to Supabase Object Storage before or alongside AI processing
- Payment instruction is stored verbatim (after trimming) with the result record

#### App Version Display

A small version indicator MUST be displayed at the very bottom of Page 1.

##### Display Requirements

- **Position:** At the very bottom of the page layout, visually separated from the main form content
- **Content:** Must include a label (e.g., "Version:") followed by the current application version
- **Styling:**
  - Use shadcn-compatible typography
  - Subtle, non-distracting appearance
  - Clearly readable
  - Appropriate for mobile-first layout

##### Version Source Rules (NON-NEGOTIABLE)

- The application version MUST:
  - Be read directly from the project's `package.json`
  - Be treated as the **single source of truth**
  - Update automatically when the project version changes
- The version MUST NOT:
  - Be hardcoded in UI components
  - Be duplicated in environment variables
  - Be manually updated in multiple places

##### Non-Functional Constraints

- The version display:
  - Is informational only
  - Has no user interaction
  - Does not affect app behavior
- This feature:
  - Does NOT add a new page
  - Does NOT alter the 2-page constraint
  - Does NOT introduce configuration complexity

### **Page 2: Split Bill Result Page**

This page displays the structured output generated by the AI.

**URL Pattern:** `/result/{uuid}`

- Each result is accessible via a unique, cryptographically random UUID v4
- The page is publicly accessible without authentication (unless visibility is Private)
- Direct URL access does NOT count as an additional page

#### Access Control Behavior (New)

**Public Result:**
- If visibility is Public, show the result immediately.

**Private Result:**
- If visibility is Private, the page MUST NOT show result details immediately.
- **Initial State:** Show a shadcn `Card` with a passcode prompt.
  - Required: Passcode input (shadcn `Input`) + Submit button (shadcn `Button`).
- **Validation:**
  - Verify passcode against server-side hash.
  - Failure: Show inline error (shadcn `Alert` destructive or `FormMessage`). Allow retry.
  - Success: Reveal the full result UI.
- **Security:**
  - validation MUST occur server-side.
  - Brute-force protection is optional (future scope).

#### Output Requirements

The AI must return data that can be rendered into:

- A **clear per-person breakdown**
- Each person must have:
  - List of food items
  - List of drink items
  - Subtotal before additional fees
  - Allocated tax amount
  - Allocated service fee
  - Final total payable

#### Calculation Rules (MANDATORY)

- All taxes, service fees, and additional charges:
  - MUST be included in the final calculation
  - MUST be distributed **proportionally**, based on the value of food/drinks consumed by each person
- No rounding assumptions unless explicitly stated by the AI
- Final totals must be clearly shown per person

#### Presentation Requirements

- Output must be:
  - Human-readable
  - Structured
  - Visually scannable
- Example sections:
  - Person 1 Summary
  - Person 2 Summary
  - Grand Total (reference)

#### Share Functionality

- A **Share button** MUST be displayed on the result page
- Behavior:
  - Copies the full UUID-based result URL to clipboard
  - Uses shadcn `Button` component
  - Shows feedback using shadcn `Toast` component
  - **Note:** For private results, the URL is the same, but access will require passcode entry. Passcode is NEVER in the URL.
- Constraints:
  - No social SDKs
  - No third-party share libraries

#### Payment Instruction Display (Conditional)

**Visibility Rules:**
- If `payment_instruction` is NULL or empty ‚Üí the entire section is **completely hidden**.
- If `payment_instruction` is present ‚Üí show a dedicated section near share controls.

**Display Requirements:**
- Wrap the section in a shadcn `Card` component
- Use a clear heading (e.g., "Payment Instruction")
- Display exactly what the user entered ‚Äî **no rewriting, reformatting, or masking of numbers**
- If text is long, optionally render inside shadcn `ScrollArea`

**Copyable Text Requirement:**
- Provide a **Copy** button (shadcn `Button`) that copies the exact instruction string to clipboard
- Show copy feedback using shadcn `Toast` component with success message
- The copied text must be the raw value, no modifications

#### Receipt Image Display

- The original receipt image MUST be displayed at the bottom of the result page
- Display requirements:
  - Wrapped inside a shadcn `Card` component
  - Clearly labeled (e.g., "Original Receipt")
  - Read-only (no editing or replacement)
  - Uses shadcn-friendly layout components (e.g., `AspectRatio`, `ScrollArea`)

    - Uses shadcn-friendly layout components (e.g., `AspectRatio`, `ScrollArea`)

---

## üõÇ Admin Authentication & User Management (NEW)

### Admin Authentication

- **Provider:** Supabase Auth ONLY.
- **Method:** Email + Password.
- **Registration Constraints:**
  - ‚ùå **No public sign-up**.
  - ‚úÖ **Invite-only**: New admins must be invited by an existing admin via Supabase Auth `inviteUserByEmail` API.
- **Login Page:**
  - Dedicated route (e.g., `/admin/login`).
  - No social login providers.
- **Password Management:**
  - Admin users MUST be able to reset their password using Supabase's built-in reset flow.
  - All auth flows MUST use Supabase SDK/APIs.
  - **Forbidden:** Custom auth logic or tables.

### Admin Dashboard (Protected)

The Admin Dashboard allows authorized users to manage admin access and oversee operations.

**Route:** `/admin/dashboard` (Protected server-side)

#### 1. Admin User Management
- **Capabilities:**
  - **Invite Admin:** Form to invite a new admin by email.
  - **List Admins:** Table showing:
    - Email
    - Created Date
    - Status (Active / Invited / Etc.)
- **Constraints:**
  - Admin users require email + password only.
  - No profile customization (name, avatar, etc.).
  - No role hierarchy (all admins are super-admins).

#### 2. Split Bill Management
- **List View:**
  - Display all split bills in a **Paginated Table** (shadcn `Table` + `Pagination`).
  - **Columns:**
    - UUID (truncated or link)
    - Total Amount
    - Total Number of People
    - Visibility (Public / Private)
    - Created At
    - **Actions:**
        - "View Detail" button (opens Modal).
        - "Copy Link" button (copies full result URL).
- **Server-Side Pagination:** Required (Supabase-driven).

- **Detail View (Modal/Dialog):**
  - Triggered by "View Detail".
  - **Content:**
    - Simplified bill breakdown (Per-person summary).
    - Total fees/taxes.
    - **Receipt Image Preview** (shadcn `AspectRatio`).
  - **Actions:**
    - "Copy Public Link" (shadcn `Button`).
    - "Close" (shadcn `DialogClose`).
  - **Constraints:**
    - Read-only.
    - **No editing** of bill data.
    - **No deletion** of bill data.

#### 3. Admin Responsive Layout
- **Desktop (lg+):**
  - Persistent sidebar navigation (shadcn `Sidebar` with `SidebarProvider`).
  - Full table columns visible with proper spacing.
  - Sidebar collapsible via `SidebarTrigger`.
- **Tablet (md):**
  - Sidebar collapsible to icon-only mode.
  - Tables remain usable with horizontal scroll (shadcn `ScrollArea`).
- **Mobile (sm):**
  - Sidebar converts to Sheet drawer (shadcn `Sheet`).
  - Table columns progressively hidden; essential data visible.
  - Horizontal scroll for full table access.
  - Actions remain accessible via icon buttons.
- **Approved Components:**
  - `Sidebar`, `SidebarProvider`, `SidebarInset`, `SidebarTrigger`
  - `Sheet` (mobile navigation drawer)
  - `ScrollArea` (horizontal table scroll)
  - `Table`, `Card`, `Button`, `Dialog`

---

## üóÑÔ∏è Data Persistence & Storage

### Supabase Database

All AI-generated split bill results MUST be persisted in Supabase.

#### Storage Timing

- Results are stored **immediately after successful AI processing**
- Writes occur **server-side only**

#### Result Record Schema

| Field                 | Type      | Description                                              |
| --------------------- | --------- | -------------------------------------------------------- |
| `id`                  | UUID (PK) | Cryptographically random UUID v4                         |
| `result_data`         | JSON      | Structured split bill result                             |
| `currency`            | TEXT      | Currency code (e.g., "IDR", "USD")                       |
| `person_breakdown`    | JSON      | Per-person allocation details                            |
| `fees_taxes`          | JSON      | Allocated fees and taxes breakdown                       |
| `receipt_image_url`   | TEXT      | Public or signed URL to the receipt                      |
| `created_at`          | TIMESTAMP | Timestamp of record creation                             |
| `ai_model_used`       | TEXT      | Identifier of the AI model used                          |
| `visibility`          | TEXT      | 'public' OR 'private'                                    |
| `passcode_hash`       | TEXT      | Hashed passcode (NULL if public)                         |
| `payment_instruction` | TEXT      | User-provided payment instruction (NULL if not provided) |

**Payment Instruction Storage Rules:**
- Stored **server-side only** ‚Äî never processed by AI
- Stored **verbatim** (after trimming leading/trailing whitespace)
- Returned **verbatim** to the result page
- NULL if not provided by the user

#### UUID Rules (NON-NEGOTIABLE)

- UUIDs MUST:
  - Be cryptographically random (UUID v4)
  - Be non-guessable
  - Be generated server-side
- UUIDs MUST NOT:
  - Be sequential
  - Be derived from timestamps
  - Be hashed from internal IDs
  - Encode user or bill metadata

### Receipt Image Storage

- Receipt images MUST be uploaded to **Supabase Object Storage**
- Upload timing: Before or alongside AI processing
- Storage rules:
  - Images are **immutable** after upload (no modification or replacement)
  - Image URL is public-read or signed-read (implementation choice)
  - The stored image URL MUST be saved with the result record

---

## üîê Security & Access Control

### Public Result Access

- Result pages are:
  - Publicly accessible via UUID
  - Read-only (no modifications allowed)
  - Non-enumerable (no listing or pagination)
- No authentication required to view results

### Server-Side Security & Guard Rails


- Supabase service keys MUST remain server-side only
- Passcodes MUST be hashed (e.g., bcrypt/argon2) before storage. NEVER store in plaintext.
- Hashing and verification MUST occur server-side only.
- No sensitive or personal data is exposed on public result pages
- Results CANNOT be deleted or updated via public access
- Receipt images cannot be modified or replaced after upload

### Admin Security Guard Rails (MANDATORY)

- **Access Control:**
  - Admin routes (`/admin/*`) MUST be protected via **Server-Side** checks (e.g., SvelteKit Hooks).
  - Admin dashboard is **NOT** accessible via public UUID URLs.
  - No admin actions via client-only checks.

- **LLM Guard Rails:**
  - The LLM MUST:
    - **NOT** be used for admin authentication logic.
    - **NOT** interpret or process admin user data.
    - **NOT** generate admin-only business logic.
  - Admin dashboard data is handled via strict Supabase queries ONLY.

---

## üé® UI & Design System (NON-NEGOTIABLE)

### Component Rules

ALL UI components MUST:
- Use **shadcn components only**
- Follow shadcn composition and variant patterns

### Allowed

- shadcn components (Button, Card, Input, Toast, Alert, AspectRatio, ScrollArea, etc.)
- Tailwind utility classes for spacing/layout

### Forbidden

- Custom UI components (components not from shadcn)
- Inline styles
- Third-party UI libraries

### Admin UI Constraints
- **Admin Dashboard MUST use:**
  - `shadcn` dashboard layout (Sidebar/Topnav pattern).
  - `shadcn` components for Tables, Pagination, Dialogs, Buttons, Forms.
- **Forbidden:**
  - Custom dashboard components.
  - Inline styles for layout.

---

## ü§ñ AI & LLM Configuration

### AI Responsibilities

The AI is responsible for:

- Reading and interpreting receipt image contents
- Extracting item names, prices, taxes, and fees
- Mapping items to individuals based on extra instructions
- Calculating fair cost distribution
- Producing structured, explainable output

### LLM Provider

- **API Gateway:** OpenRouter API

### Models

- **Default Model:** `openai/gpt-4o-mini`
- **Fallback Model:** `google/gemini-2.0-flash-001`

### Configuration Rules

- LLM model selection MUST be configurable via environment variables
- No model identifiers may be hardcoded

---

## üß† Prompting & Safety Rules

- AI prompts must:
  - Include receipt OCR data
  - Include number of people
  - Include user extra instructions verbatim
- Input must be sanitized to reduce prompt injection risk
- AI output must be deterministic and structured

### LLM Guard Rails for Payment Instruction (MANDATORY)

> [!CAUTION]
> `payment_instruction` is **NOT** AI input and must NEVER be processed by the LLM.

**The LLM MUST NOT:**
- Receive `payment_instruction` as part of the prompt
- Use `payment_instruction` for bill splitting, reasoning, inference, or validation
- Rewrite, "clean up", reformat, or extract numbers from the payment instruction
- Infer that it is a bank account, phone number, or payment method
- Summarize, parse, or validate the payment instruction content

**Treatment as Opaque Metadata:**
- `payment_instruction` is treated as **opaque user-provided metadata**
- It is stored and displayed verbatim
- Copy action copies the raw value exactly as entered
- No AI processing or transformation is permitted

---

## üß™ Testing & Validation Requirements

### Automated Tests (Playwright + Gherkin)
- **Admin Login:**
  - Verify success with valid credentials.
  - Verify failure with invalid credentials.
  - Verify redirection to Login if unauthenticated.
- **Admin Registration:**
  - Verify invite-only flow (API mock or check).
- **Split Bill Management:**
  - Verify List View renders with pagination.
  - Verify Detail Modal opens and displays correct data.
  - Verify "Copy Link" functionality works in dashboard.
- **Password Reset:**
  - Verify reset flow initiation.

### Payment Instruction Tests (Playwright + Gherkin)

All scenarios below MUST be covered by automated tests:

- **Page 1 ‚Äî Optional Input:**
  - Verify payment instruction field is visible and optional (form submits without it)
  - Verify max length validation (300 chars) triggers error if exceeded
  - Verify whitespace is trimmed on submission

- **Page 2 ‚Äî Conditional Display:**
  - Verify result page **hides** the Payment Instruction section when `payment_instruction` is NULL/empty
  - Verify result page **shows** the Payment Instruction section when `payment_instruction` is present
  - Verify displayed text matches the exact input (no reformatting)

- **Page 2 ‚Äî Copy Functionality:**
  - Verify Copy button copies the **exact** instruction text to clipboard
  - Assert clipboard contents match the original input (use `context.grantPermissions(['clipboard-read'])` and `page.evaluate(() => navigator.clipboard.readText())`)
  - Verify shadcn Toast appears with success feedback after copying

**Test Determinism Requirements:**
- Mock Supabase reads/writes (use Supabase MCP where possible)
- Use Playwright MCP for clipboard assertions
- Tests must NOT rely on live external services

### MCP Utilization Guidelines
- **Context7 MCP:** Reference for libraries/docs.
- **Supabase MCP:**
  - Validate Auth flows.
  - Validate Admin User listing queries.
  - Validate Paginated split bill queries.
  - Validate `payment_instruction` column retrieval patterns.
- **Playwright MCP:**
  - Execute auth-protected UI tests.
  - Validate Modal interactions & clipboard operations.
  - Validate Payment Instruction copy-to-clipboard functionality.
- **Sequential Thinking MCP:**
  - Use to break down Admin Dashboard implementation into deterministic steps.

---


---

## ‚öôÔ∏è Environment Variables & Configuration

### Critical Configuration Rules

- **Source of Truth:** `.env.example` is the comprehensive reference for all required variables.
- **Production Safety:** `.env` files MUST NEVER be committed to version control.
- **Runtime Injection:** Variables are injected at runtime in the deployment environment (Render).

### Required `.env` Variables

```env
# Runtime Implementation
NODE_ENV=development
PORT=3000

# AI Provider Configuration (OpenRouter)
OPENROUTER_API_KEY=
OPENROUTER_MODEL_DEFAULT=openai/gpt-4o-mini
OPENROUTER_MODEL_FALLBACK=google/gemini-2.0-flash-001

# Supabase Configuration
# Note: Service Role Key is strictly SERVER-SIDE only.
SUPABASE_URL=
SUPABASE_ANON_KEY=
SUPABASE_SERVICE_ROLE_KEY=
```


---

## üéØ Non-Goals (Explicitly Out of Scope)

- **Public** User authentication
- **Public** User accounts
- History of past bills (Public)
- Payments or payment integrations
- More than 2 **Public** pages
- Manual editing of extracted receipt items
- **Public** Dashboards
- **Public** Pagination or result listing
- Social sharing SDKs
- Brute-force protection (current scope)
